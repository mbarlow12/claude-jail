#!/usr/bin/env bash
# claude-jail - Run Claude Code in a bubblewrap sandbox
# https://github.com/mbarlow12/claude-jail

set -euo pipefail

# Determine script directory
if [[ -n "${BASH_SOURCE[0]:-}" ]]; then
    _CJ_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
else
    _CJ_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
fi

# Source core libraries
source "$_CJ_ROOT/lib/bwrap.sh"
source "$_CJ_ROOT/lib/config.sh"
source "$_CJ_ROOT/lib/profiles.sh"
source "$_CJ_ROOT/lib/sandbox.sh"

# Load all profiles
cj::profile::load_all "$_CJ_ROOT/profiles"

_claude_jail_help() {
    cat <<'EOF'
claude-jail - Run Claude Code in a bubblewrap sandbox

USAGE
    claude-jail [OPTIONS] [-- CLAUDE_ARGS...]

OPTIONS
    -d, --dir <PATH>      Project directory (default: cwd)
    -p, --profile <NAME>  Isolation profile (default: standard)
    -v, --verbose         Show sandbox info on start
    --network             Force enable network
    --no-network          Disable network access
    --ro <PATH>           Add read-only path (can repeat)
    --rw <PATH>           Add read-write path (can repeat)
    --sandbox-home <PATH> Parent directory for sandbox (default: cwd)
    --sandbox-name <NAME> Sandbox directory name (default: .claude-sandbox)
    --git-root <PATH>     Manually specify main git repo root (for worktrees)
    --git-ro              Bind main .git read-only (default: read-write)
    --list-profiles       List available profiles
    --show-config         Show current configuration
    --help-config         Show configuration help
    -h, --help            Show this help

PROFILES
    minimal     Fast, basic isolation. Mounts /etc read-only.
    standard    Balanced. Selective /etc, preserves PATH. (default)
    paranoid    Maximum isolation. Fake paths at /work and /sandbox.
    dev         Toolchain-aware. Binds mise, cargo, nvm, etc. read-only.

CONFIGURATION
    See --help-config for detailed configuration information.
    Quick example:
        export CJ_PROFILE=paranoid
        export CJ_EXTRA_RO="/usr/local/mylib:/opt/tools"
        claude-jail

COMMANDS
    claude-jail           Run claude in sandbox
    claude-jail shell     Open bash in sandbox (for testing)
    claude-jail clean     Remove .claude-sandbox directory
    claude-jail debug     Print bwrap command without running

GIT WORKTREE SUPPORT
    claude-jail auto-detects git worktrees and binds the main .git directory.
    This enables full git operations (commit, push, etc.) from worktrees.

    # Run from parent directory with worktrees
    cd bean-barn
    claude-jail -d feat-ty-lsp   # Auto-binds ../main/.git

    # Override if auto-detection fails
    claude-jail -d feat-ty-lsp --git-root ./main

    # Read-only for extra safety (limits some git operations)
    claude-jail -d feat-ty-lsp --git-ro

EXAMPLES
    claude-jail                       # Run in current directory
    claude-jail -d ~/project          # Run in specific directory
    claude-jail -p paranoid           # Maximum isolation
    claude-jail -v -- --print "hi"    # Verbose, pass args to claude
    claude-jail debug                 # See what bwrap would run
    claude-jail shell                 # Test sandbox interactively

    # Shared sandbox between worktrees
    cd ~/repos/myproject-worktrees
    claude-jail -d main               # Sandbox at ./cwd/.claude-sandbox
    claude-jail -d feat-branch        # Same sandbox (shared)

    # Custom sandbox location
    claude-jail --sandbox-home /tmp --sandbox-name my-sandbox

SECURITY
    Inside the sandbox:
    - $HOME points to .claude-sandbox/ (or /sandbox in paranoid mode)
    - /home, /root don't exist
    - System dirs are read-only
    - Only project directory is writable

    Even `rm -rf ~` or `rm -rf /` cannot harm your real system.
EOF
}

_claude_jail_main() {
    local project_dir=""
    local profile=""
    local verbose=""
    local network=""
    local sandbox_home_override=""
    local sandbox_name_override=""
    local git_root_override=""
    local git_ro=""
    local -a cli_ro=()
    local -a cli_rw=()
    local -a claude_args=()

    # Parse args first, handle info commands before checking for bwrap
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)      _claude_jail_help; return 0 ;;
            --help-config)  cj::config::help; return 0 ;;
            --list-profiles) cj::profile::list; return 0 ;;
            --show-config)  cj::config::show; return 0 ;;
            -d|--dir)       project_dir="$2"; shift 2 ;;
            -p|--profile)   profile="$2"; shift 2 ;;
            -v|--verbose)   verbose=true; shift ;;
            --no-network)   network=false; shift ;;
            --network)      network=true; shift ;;
            --ro)           cli_ro+=("$2"); shift 2 ;;
            --rw)           cli_rw+=("$2"); shift 2 ;;
            --sandbox-home) sandbox_home_override="$2"; shift 2 ;;
            --sandbox-name) sandbox_name_override="$2"; shift 2 ;;
            --git-root)     git_root_override="$2"; shift 2 ;;
            --git-ro)       git_ro=true; shift ;;
            --)             shift; claude_args+=("$@"); break ;;
            -*)             echo "Unknown option: $1" >&2; return 1 ;;
            *)              claude_args+=("$1"); shift ;;
        esac
    done

    # Now check for bwrap
    if ! command -v bwrap &>/dev/null; then
        echo "Error: bubblewrap not found. Install: sudo apt install bubblewrap" >&2
        return 1
    fi

    project_dir="${project_dir:-$(pwd)}"
    project_dir="$(realpath "$project_dir" 2>/dev/null || echo "$project_dir")"

    if [[ ! -d "$project_dir" ]]; then
        echo "Error: Not a directory: $project_dir" >&2
        return 1
    fi

    profile="${profile:-$(cj::config::get profile standard)}"

    if ! cj::profile::exists "$profile"; then
        echo "Error: Unknown profile '$profile'" >&2
        echo "Available: $(cj::profile::list | tr '\n' ' ')" >&2
        return 1
    fi

    # Resolve sandbox home using new flexible resolution
    local sandbox_home
    sandbox_home="$(cj::sandbox::resolve_home "${sandbox_home_override:-}" "${sandbox_name_override:-}")"

    # Validate sandbox location
    local config_source=""
    if cj::config::is_user_level_config && [[ -n "$(cj::config::get sandbox_home)" ]]; then
        config_source="user"
    fi
    if ! cj::sandbox::validate_home_location "$sandbox_home" "$config_source"; then
        return 1
    fi

    cj::sandbox::init "$project_dir" "$sandbox_home" "$profile"
    cj::worktree::detect_config "$project_dir" "${verbose:-false}"
    cj::sandbox::bind_credentials "$sandbox_home" "$profile" || true

    # Detect and bind git worktree's main .git directory
    local git_worktree_ro="${git_ro:-$(cj::config::get_bool git_worktree_ro false && echo true || echo false)}"
    if [[ -n "$git_root_override" ]]; then
        git_root_override="$(realpath "$git_root_override" 2>/dev/null || echo "$git_root_override")"
    fi
    cj::git::detect_worktree "$project_dir" "$git_worktree_ro" "${verbose:-false}" "$git_root_override" || true

    # Pass through environment variables (git, proxy, API key)
    cj::env::passthrough

    if [[ "${network:-}" == "false" ]]; then
        _CJ_NS+=(--unshare-net)
    fi

    # Config file extra paths
    local -a extra_ro
    local -a extra_rw
    IFS=' ' read -ra extra_ro <<< "$(cj::config::get_extra_ro)"
    IFS=' ' read -ra extra_rw <<< "$(cj::config::get_extra_rw)"

    local p
    for p in "${extra_ro[@]}"; do
        [[ -n "$p" && -e "$p" ]] && cj::ro_bind "$p"
    done
    for p in "${extra_rw[@]}"; do
        [[ -n "$p" && -e "$p" ]] && cj::bind "$p"
    done

    # CLI path options (--ro, --rw)
    for p in "${cli_ro[@]}"; do
        [[ -n "$p" && -e "$p" ]] && cj::ro_bind "$p"
    done
    for p in "${cli_rw[@]}"; do
        [[ -n "$p" && -e "$p" ]] && cj::bind "$p"
    done

    local claude_bin
    claude_bin="$(cj::path::find_real claude)" || {
        echo "Error: claude not found in PATH" >&2
        return 1
    }

    local chdir_path
    chdir_path="$(cj::sandbox::chdir_path "$project_dir" "$profile")"

    if [[ "${verbose:-false}" == true ]]; then
        cj::sandbox::print_info "$project_dir" "$sandbox_home" "$profile" "$claude_bin"
    fi

    cj::chdir "$chdir_path"
    cj::run "$claude_bin" "${claude_args[@]}"
}

_claude_jail_shell() {
    local project_dir="${1:-$(pwd)}"
    local profile="${2:-$(cj::config::get profile standard)}"

    project_dir="$(realpath "$project_dir" 2>/dev/null || echo "$project_dir")"
    local sandbox_home
    sandbox_home="$(cj::sandbox::resolve_home)"

    cj::sandbox::init "$project_dir" "$sandbox_home" "$profile"
    cj::sandbox::bind_credentials "$sandbox_home" "$profile" || true
    cj::env::passthrough
    cj::git::detect_worktree "$project_dir" "$(cj::config::get_bool git_worktree_ro false && echo true || echo false)" false "" || true

    local chdir_path
    chdir_path="$(cj::sandbox::chdir_path "$project_dir" "$profile")"

    cj::sandbox::print_shell_info "$sandbox_home" "$profile"

    cj::chdir "$chdir_path"
    cj::run /bin/bash
}

_claude_jail_clean() {
    local project_dir="${1:-$(pwd)}"
    local sandbox_home
    sandbox_home="$(cj::sandbox::resolve_home)"

    if [[ -d "$sandbox_home" ]]; then
        echo "Removing $sandbox_home ..."
        rm -rf "$sandbox_home"
        echo "Done."
    else
        echo "No sandbox found at $sandbox_home"
    fi
}

_claude_jail_debug() {
    local project_dir="${1:-$(pwd)}"
    local profile="${2:-$(cj::config::get profile standard)}"

    project_dir="$(realpath "$project_dir" 2>/dev/null || echo "$project_dir")"
    local sandbox_home
    sandbox_home="$(cj::sandbox::resolve_home)"

    # Create sandbox directories so bind mounts don't fail (but don't copy config)
    cj::sandbox::create_dirs "$sandbox_home"

    cj::reset
    cj::profile::apply "$profile" "$project_dir" "$sandbox_home"
    cj::worktree::detect_config "$project_dir" false
    cj::sandbox::bind_credentials "$sandbox_home" "$profile" || true
    cj::env::passthrough
    cj::git::detect_worktree "$project_dir" "$(cj::config::get_bool git_worktree_ro false && echo true || echo false)" false "" || true

    local chdir_path
    chdir_path="$(cj::sandbox::chdir_path "$project_dir" "$profile")"
    cj::chdir "$chdir_path"

    echo "# Profile: $profile"
    echo "# Project: $project_dir"
    echo "# Sandbox: $sandbox_home"
    echo ""

    local -a cmd
    cmd=(bwrap --die-with-parent --new-session)
    cmd+=("${_CJ_NS[@]}")
    cmd+=("${_CJ_PRE[@]}")
    cmd+=("${_CJ_BINDS[@]}")
    cmd+=("${_CJ_ENV[@]}")
    cmd+=(-- claude)

    printf '%q \\\n    ' "${cmd[@]}"
    echo '"$@"'
}

# Main dispatcher
case "${1:-}" in
    shell)
        shift
        _claude_jail_shell "$@"
        ;;
    clean)
        shift
        _claude_jail_clean "$@"
        ;;
    debug)
        shift
        _claude_jail_debug "$@"
        ;;
    -h|--help)
        _claude_jail_help
        ;;
    --help-config)
        cj::config::help
        ;;
    *)
        _claude_jail_main "$@"
        ;;
esac
